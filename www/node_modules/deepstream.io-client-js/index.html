<!DOCTYPE html>
<html>
  <head>
    <script src="dist/deepstream.js"></script>
  </head>
  <body>
    <label id="server"></label>
    <label id="mode"></label><br>
    <input id="input" type="text" /><br>
    <textarea rows="10" cols="50" readonly id="output"></textarea><br>
    <script type="text/javascript">
    try {
      var port = (window.location.search.match(/port=(.*)/) || [null, 6020])[1]
      var server = document.getElementById('server')
      var mode = document.getElementById('mode')
      var output = document.getElementById('output')
      var input = document.getElementById('input')

      var intervalId = null
      server.textContent = 'localhost:' + port
      var client = deepstream('localhost:' + port)
      client.on('error', function() {
        console.error(arguments)
        throw new Error()
      })
      client.login({}, function(success, data) {
        if (!success) {
          console.error(data)
          return alert('error')
        }
        console.log('connected')
        mode.textContent = window.location.hash
        if (window.location.hash === '#e-subscriber') {
          client.event.subscribe( 'news/sports', (data) => {
            console.log('subscribe', data)
          })
        } else if (window.location.hash === '#e-emitter') {
           client.event.emit( 'news/sports', {
             headline: 'New Olympics location announced',
             content: 'In a surprising twist, the committee has chosen...'
          });
        } else if (window.location.hash === '#e-provider') {
          client.event.listen( '^news/.*', ( eventName, isSubscribed, response ) => {
            if (!isSubscribed) {
              console.log('stopping to provide', eventName, intervalId)
              return clearInterval(intervalId)
            }
            response.accept()
            client.event.emit(eventName, 'ACK')
            intervalId = setInterval(() => {
              console.log('sending ping to subscribers of', eventName)
              client.event.emit(eventName, 'ping')
            }, 1000 )
          });
        } else if (window.location.hash === '#r-subscriber') {
          console.log('wtf1')
          var name = 'raceHorse/fast-betty'
          if (Math.random() > 0.5) {
            name = 'raceHorse/slow-betty'
          }
          console.log('subscribe to', name)
          var r = client.record.getRecord( name )
          console.log('hasProvider', r.hasProvider)
          r.on('hasProviderChanged', function() {
            console.log('hasProviderChanged', arguments)
            console.log('hasProvider', r.hasProvider)
          })
          setTimeout(() => {
            r.discard()
            console.log('discarded')
          }, 5000)
        } else if (window.location.hash === '#r-provider') {
          console.log('wtf2')
          var raceHorseRecords = {}
          var pattern = 'raceHorse/fast.*'
          client.record.listen( 'raceHorse/fast.*', function( match, isSubscribed, response ) {

              /*
                   + match = 'raceHorse/fast-betty'
                   + isSubscribed = true
               */

              console.log('isSubscribed', isSubscribed)
              if( isSubscribed ) {
                  response.accept()
                  raceHorseRecords[ match ] = client.record.getRecord( match );
              } else {
                  raceHorseRecords[ match ].discard();
                  delete raceHorseRecords[ match ];
              }
          });
          client.record.listen( 'raceHorse/slow.*', function( match, isSubscribed, response ) {

              /*
                   + match = 'raceHorse/fast-betty'
                   + isSubscribed = true
               */

              console.log('isSubscribed', isSubscribed)
              if( isSubscribed ) {
                  response.accept()
                  raceHorseRecords[ match ] = client.record.getRecord( match );
              } else {
                  raceHorseRecords[ match ].discard();
                  delete raceHorseRecords[ match ];
              }
          });

        }

      });

    } catch (err) {
    	document.write('foo', err.toString())
    }
    </script>
  </body>
</html>
